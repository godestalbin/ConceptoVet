@model ConceptoVet.Models.Contact

<p id="debugText">

</p>

    <div class="container">



@using (Html.BeginForm("Contact", "Contact",
                 FormMethod.Post, new { role = "form", id = "contactForm" }))
{
    @Html.AntiForgeryToken()
    @Html.ValidationSummary(true)

    <fieldset>

@*    //Test to have fields in 2 columns
    <div class="row clearfix">
        <div class="col-md-6 column">
		</div>
		<div class="col-md-6 column">
		</div>
	</div>*@

    <div class="row top-buffer">
@*        <div class="col-md-1">
        </div>*@
        <div class="col-md-3 top-buffer-validation float text-right">
            @Html.LabelFor(model => model.clinique)
        </div>
        <div class="col-md-3 float">
            @Html.TextBoxFor(model => model.clinique, new { @class = "form-control" })
        </div>
        <div class="col-md-3 top-buffer-validation float">
            @Html.ValidationMessageFor(model => model.clinique)
        </div>
        <div class="col-md-3 float">
        </div>
@*        <div class="col-md-1">
        </div>*@
    </div>
    <div class="row top-buffer-validation">
@*        <div class="col-md-1">
        </div>*@
        <div class="col-md-3 top-buffer-validation float text-right">
            @Html.LabelFor(model => model.name)
        </div>
        <div class="col-md-3 float">
            @Html.TextBoxFor(model => model.name, new { @class = "form-control" })
        </div>
        <div class="col-md-3 top-buffer-validation float">
            @Html.ValidationMessageFor(model => model.name)
        </div>
        <div class="col-md-3 float">
        </div>
@*        <div class="col-md-1">
        </div>*@
    </div>

@*    <div class="row top-buffer">
        <div class="col-md-3 float">
            @Html.LabelFor(model => model.phone)
        </div>
        <div class="col-md-3 float">
        </div>
        <div class="col-md-3 float">
        </div>
        <div class="col-md-3 float">
        </div>
        <div class="col-md-1">
        </div>
    </div>*@
    <div class="row top-buffer-validation">
@*        <div class="col-md-1">
        </div>*@
        <div class="col-md-3 top-buffer-validation float text-right">
            @Html.LabelFor(model => model.phone)
        </div>
        <div class="col-md-3 float">
            @Html.TextBoxFor(model => model.phone, new { @class = "form-control" })
        </div>
        <div class="col-md-3 top-buffer-validation float">
            @Html.ValidationMessageFor(model => model.phone)
        </div>
        <div class="col-md-3 float">
        </div>
@*        <div class="col-md-1">
        </div>*@
    </div>

    <div class="row top-buffer-validation">
        <div class="col-md-3 top-buffer-validation float text-right">
            @Html.LabelFor(model => model.mail)
        </div>
        <div class="col-md-3 float">
            @Html.TextBoxFor(model => model.mail, new { @class = "form-control" })
        </div>
        <div class="col-md-3 top-buffer-validation float">
            @Html.ValidationMessageFor(model => model.mail)
        </div>
        <div class="col-md-3 float">
        </div>
    </div>

    <div class="row top-buffer-validation">
        <div class="col-md-3 top-buffer-validation float text-right">
            @Html.LabelFor(model => model.zipCode)
        </div>
        <div class="col-md-3 float">
            @Html.TextBoxFor(model => model.zipCode, new { @class = "form-control" })
        </div>
        <div class="col-md-3 top-buffer-validation float">
            <div id="city"></div>
            @Html.ValidationMessageFor(model => model.zipCode)
            <div id="unknownZipCode" class="field-validation-error nodisplay">Code postal inconnu</div>
        </div>
        <div class="col-md-3 float">
        </div>
    </div>

@*    <div id="debugServiceFee"></div>
    <div id="debugDistance"></div>*@

    @*Furniture catalogue with image*@
    <div class="row top-buffer">
@*        <div class="col-md-1">
        </div>*@
        <div class="col-md-12 top-buffer-validation">
            <div id="furnitureCatalogue" class="panel panel-primary nodisplay">
                <div class="panel-heading">Catalogue des meubles ConceptoVet</div>
                <div id="furnitureCatalogueBody" class="panel-body">
                    <div class="catalogue-furniture">
                        <img id="ref1" src="https://s3.amazonaws.com/conceptovet/images/Chiens 205.png" reference="1" retail="2300" title="Meuble Aliments Profondeur 80 cm x 2.05 m" alt="alternative text">
                    </div>
                    <div class="catalogue-furniture">
                        <img id="ref2" src="https://s3.amazonaws.com/conceptovet/images/Chiens 275.png" reference="2" retail="2800" title="Meuble Aliments Profondeur 80 cm x 2.75 m">
                    </div>
                    <div class="catalogue-furniture">
                        <img id="ref+3" src="https://s3.amazonaws.com/conceptovet/images/Chats 205.png" reference="3" retail="2100" title="Meuble Aliments Profondeur 55 cm x 2.05 m">
                    </div>
                    <div class="catalogue-furniture">
                        <img id="ref4" src="https://s3.amazonaws.com/conceptovet/images/Chats 275.png" reference="4" retail="2700" title="Meuble Aliments Profondeur 55 cm x 2.75 m">
                    </div>
                    <div class="catalogue-furniture">
                        <img id="ref5" src="https://s3.amazonaws.com/conceptovet/images/Soins 135.png" reference="5" retail="1300" title="Meuble Soins Profondeur 40 cm x 1.35 m">
                    </div>
                    <div class="catalogue-furniture">
                        <img id="ref6" src="https://s3.amazonaws.com/conceptovet/images/Soins 205.png" reference="6" retail="1700" title="Meuble Soins Profondeur 40 cm x 2.05 m">
                    </div>
                    <div class="catalogue-furniture">
                        <img id="ref7" src="https://s3.amazonaws.com/conceptovet/images/Soins 275.png" reference="7" retail="2200" title="Meuble Soins Profondeur 40 cm x 2.75 m">
                    </div>
                    <div class="catalogue-furniture">
                        <img id="ref8" src="https://s3.amazonaws.com/conceptovet/images/Soins tiroirs 135.png" reference="8" retail="1800" title="Meuble Soins avec Tiroirs Profondeur 44 cm x 1.35 m">
                    </div>
                    <div class="catalogue-furniture">
                        <img id="ref9" src="https://s3.amazonaws.com/conceptovet/images/Soins tiroirs 205.png" reference="9" retail="2700" title="Meuble Soins avec Tiroirs Profondeur 44 cm x 2.05 m">
                    </div>
                    <div class="catalogue-furniture">
                        <img id="ref10" src="https://s3.amazonaws.com/conceptovet/images/Soins tiroirs 275.png" reference="10" retail="3700" title="Meuble Soins avec Tiroirs Profondeur 44 cm x 2.75 m">
                    </div>
                    <div class="catalogue-furniture">
                        <img id="ref11" src="https://s3.amazonaws.com/conceptovet/images/Accueil droit.png" reference="11" retail="1500" title="Comptoir Individuel Largeur 1.20 m x Profondeur 80 cm droit">
                    </div>
                    <div class="catalogue-furniture">
                        <img id="ref12" src="https://s3.amazonaws.com/conceptovet/images/Accueil gauche.png" reference="12" retail="1500" title="Comptoir Individuel Largeur 1.20 m x Profondeur 80 cm gauche">
                    </div>
                    <div class="catalogue-furniture">
                        <img id="ref13" src="https://s3.amazonaws.com/conceptovet/images/Accueil double.png" reference="13" retail="2400" title="Comptoir Double Largeur 2.10 m x Profondeur 80 cm">
                    </div>
                </div>
                <div class="panel-footer">Cliquez sur les meubles pour les ajouter à votre estimation</div>
            </div>
        </div>
    </div>

    @*Quotation panel with image*@
    <div class="row">
@*        <div class="col-md-1">
        </div>*@
        <div class="col-md-12 top-buffer-validation">
            <div id="furnitureQuotation" class="panel panel-primary nodisplay">
                <div class="panel-heading">Meubles inclus dans votre estimation</div>
                <div id="furnitureQuotationBody" class="panel-body">
@*                    <img id="ref"+1" src="/Images/Chiens 205.png" reference="1" retail="1200" title="Meuble chiens 205cm">
                    <img id="ref"+2" src="/Images/Chiens 275.png" reference="2" retail="1400" title="Meuble chiens 275cm">*@
                    Aucun meuble dans votre estimation
                </div>
                @*<div class="panel-footer">Cliquez sur les meubles pour les supprimer de votre devis</div>*@
            </div>
        </div>
    </div>

    @*Quotation table*@
    <div id="quotationTable" class="row nodisplay">
@*        <div class="col-md-1">
        </div>*@
        <div class="col-md-12 top-buffer-validation">
            <div class="panel panel-primary">
                <div class="panel-heading">Votre estimation personnalisée</div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th class="numeric">Qté</th>
                            <th class="numeric">Prix</th>
                            <th class="numeric">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Chiens 205 cm</td>
                            <td class="numeric">1</td>
                            <td class="numeric">1900</td>
                            <td class="numeric">1900</td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <th>Prix total</th>
                            <td></td>
                            <td></td>
                            <th class="numeric">1900</th>
                        </tr>
                    </tfoot >
                </table>
            </div>
        </div>
    </div>


    <div id="sendContactRow" class="row nodisplay">
@*        <div class="col-md-1">
        </div>*@
        <div class="col-md-3 top-buffer-validation">
        <input id="sendContact" type="button" value="Je souhaite recevoir une copie de cette estimation et être contacté par Créadismo" class="btn btn-primary" onclick="PostQuotation();"/>
        </div>
    </div>

    </fieldset>
} @*Html.BeginForm*@
        </div> @*container*@

<div id="messagePopup" class="alert alert-success popup-panel" style="display: none">Estimation envoyé à l'adresse mail go@go.com</div>

@section Scripts {
    @*Google API key*@
    <script type="text/javascript"
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC0KjUdM6DpNQAggngGkuKLFvoHw-lJ0H4&sensor=false">
    </script>
    <script>

        //Get the distance using Google Maps matrix API
        function getDistance(zipCode) {
            var service = new google.maps.DistanceMatrixService();
            service.getDistanceMatrix(
              {
                  origins: ["82290, France"], //Set here the zip code start for transport: Meauzac
                  destinations: [zipCode + ", France"],
                  travelMode: google.maps.TravelMode.DRIVING
                  //unitSystem: UnitSystem,
                  //durationInTraffic: Boolean,
                  //avoidHighways: false,
                  //avoidTolls: false
              }, processDistance);
        }

        //Process the distance returned by Google Maps matrix API
        function processDistance(response, status) {
            //displayPopupMessage("processDistance");
            estimatedDistance = null;
            //$("#debugDistance").html("Distance=" + estimatedDistance);
            if (status == google.maps.DistanceMatrixStatus.OK) {
                if (response.rows.length >= 1) {
                    var destination = response.destinationAddresses[0].split(',');
                    if ($("#zipCode").val() == destination[0].substring(0, 5)) {
                        var city = destination[0].substring(6);
                        //displayPopupMessage(city);
                        $("#city").show();
                        $("#city").html(city) //Show city
                        if (response.rows[0].elements.length >= 1) {
                            estimatedDistance = response.rows[0].elements[0].distance.value / 1000;
                            //$("#debugDistance").html("Distance=" + estimatedDistance);
                            //$('#debugText').empty();
                            //$('#debugText').append(response.rows[0].elements[0].distance.text);
                            //Set the appropriate value for transport and installation fee
                            if (estimatedDistance > 800) serviceFee = 5200;
                            else if (estimatedDistance > 600) serviceFee = 4400;
                            else if (estimatedDistance > 400) serviceFee = 3600;
                            else if (estimatedDistance > 200) serviceFee = 2800;
                            else serviceFee = 2000;
                            //$("#debugServiceFee").html("Service fee=" + serviceFee);
                            if (estimatedDistance != null) {
                                //displayPopupMessage("Distance estimée = " + estimatedDistance + " kilomètres");
                                //$("#furnitureCatalogue").removeClass("nodisplay");
                                //$("#furnitureCatalogue").show();
                                //PostContact(); //Record contact's data
                            }
                            //Refresh the quotation
                            //UpdateQuotationGrid();
                            //$("input[type=submit]").removeAttr("disabled");
                        }
                    }
                    else { //Non existant zip code
                        estimatedDistance = null;
                        //Display error message
                        $("#unknownZipCode").show();
                        
                    }
                }
            }
            controlContactData();
        }

        function showClientError(message) {
            var $div = $('.validation-summary-errors');
            if ($div.length == 0) {
                $div = $('<div class="validation-summary-errors">');
                $div.html('<ul></ul>');
            }
            $div.find('ul').append($('<li>').text(message));
        }

        //Post contact's data to the server
        //This is called when the zipcode has been provided and distance has been calculated
        function PostContact() {
            //alert($("#zipCode").val());
            if (postedContact != $("#clinique").val() + $("#name").val() + $("#phone").val() + $("#mail").val() + $("#zipCode").val()) {
                displayPopupMessage("Posting contact");
                postedContact = $("#clinique").val() + $("#name").val() + $("#phone").val() + $("#mail").val() + $("#zipCode").val();
                //TMP
                $.post("/Contact/Contact",
                    { clinique: $("#clinique").val(), name: $("#name").val(), phone: $("#phone").val(), mail: $("#mail").val(), zipCode: $("#zipCode").val() }
                );
            }
        }

        //Post quotation's data to the server
        //http://www.webcognoscere.com/post/How-to-POST-a-JSON-object-to-a-Controller-Action.aspx
        function PostQuotation() {
            //Retrieve contact data in the form
            contact = new Object();
            contact.name = $("#name").val();
            contact.phone = $("#phone").val();
            contact.mail = $("#mail").val();
            contact.zipCode = $("#zipCode").val();
            quotation = new Object();
            quotation.contact = contact;

            //Retrieve the furniture in the furniture quotation
            furnitures = new Array();
            var previousReference = 0;
            for (var i = 0; i < furnitureQuotation.length; i++) {
                if (previousReference != furnitureQuotation[i].attr("reference")) {
                    previousReference = furnitureQuotation[i].attr("reference")
                    furniture = new Object();
                    furniture.Id = furnitureQuotation[i].attr("reference");
                    furniture.Description = furnitureQuotation[i].attr("title");
                    furniture.Picture = furnitureQuotation[i].attr("src");
                    furniture.Qty = 1;
                    furniture.Retail = furnitureQuotation[i].attr("retail");
                    furnitures.push(furniture);
                }
                else
                    furniture.Qty += 1;
            }
            quotation.furnitures = furnitures;

            //Get the service fee as funiture with the ID 99
            furniture = new Object();
            furniture.Id = 99;
            furniture.Description = "Transport et installation à proximité de " + $("#city").html();
            furniture.Qty = 1;
            furniture.Retail = serviceFee;
            furnitures.push(furniture);

            $.ajax({
                type: 'POST',
                url: '/Quotation/Quotation',
                contentType: 'application/json',
                data: JSON.stringify(quotation)
            });

            //Display popup message to show mail was sent
            //alert($("#sendQuotation").offset().top);
            displayPopupMessage("L'estimation à été envoyée à l'adresse mail: " + $("#mail").val(), 10000, 300, $("#sendContact").offset().top - $(window).scrollTop() - 50);
        }

        //Display message in a popup
        function displayPopupMessage(message, delay, width, top) {
            delay = typeof delay !== 'undefined' ? delay : 2000; //Default delay is 2 sec
            width = typeof width !== 'undefined' ? width : 300; //Default delay is 300px
            top = typeof top !== 'undefined' ? top : 5;
            $("#messagePopup").css("width", width);
            $("#messagePopup").css("top", top);
            $("#messagePopup").text(message);
            $("#messagePopup").toggle("blind", { direction: "left" }, 500);
            setTimeout(function () { $("#messagePopup").toggle("blind", { direction: "left" }, 500) }, delay);
        }

        function keyupName(event) {
            controlContactData();
        }

        function keyupPhone(event) {
            controlContactData();
        }

        function keyupMail(event) {
            controlContactData();
        }

        //Key released (generating characters) in the zipCode input
        function keyupZipCode(event) {
            $("#city").hide();
            $("#unknownZipCode").hide();
            if ($("#zipCode").val().match("^[0-9]{5}$")) //exactly 5 digits
                getDistance($("#zipCode").val());
            else {
                serviceFee = null;
                controlContactData();
            }
        }

        //Control validity of contact data
        //If valid display quotation else hide quotation
        function controlContactData() {
            if (serviceFee != null && $("#contactForm").valid()) {
                //displayPopupMessage("Valid", 500);
                PostContact();
                if (!$("#furnitureCatalogue").is(":visible")) {
                    $("#furnitureCatalogue").show("blind", 500);
                    setTimeout(function () { $("#furnitureQuotation").show("blind", 500) }, 400);
                }
                //setTimeout(function () { $('#furnitureCatalogue').goTo() }, 900);

                UpdateQuotation();
            }
            else {
                //displayPopupMessage("Invalid", 500);
                $("#furnitureCatalogue").hide();
                $("#furnitureQuotation").hide();
                $("#quotationTable").hide();
                $("#sendContact").hide();
            }
        }

        //Click on furniture in the catalogue: add to quotation
        function catalogueFurnitureClick(event) {
            //Add the img at the end of the furnitureQuotation array
            furnitureQuotation[furnitureQuotation.length] = $(event.target).children('img')
            //Sort the furnitureQuotation array
            furnitureQuotation.sort(function (a, b) { return (a.attr("reference") - b.attr("reference")); });

            UpdateQuotation();
        }

        //Click on furniture in the quotation: remove from quotation
        function quotationFurnitureClick(event) {
            //Remove the first reference in furnitureQuotation array
            for (var i = 0; i < furnitureQuotation.length; i++) {
                if (furnitureQuotation[i].attr("reference") == $(event.target).children('img').attr("reference")) {
                    furnitureQuotation.splice(i, 1);
                    break;
                }
            }
            UpdateQuotation();
        }

        //Redisplay images in quotation base on image stored in furnitureQuotation array
        //Also update the quotation table
        function UpdateQuotation() {
            //Clean all the images in the quotation
            $('#furnitureQuotationBody').empty();
            //Clean the quotation table
            $('#quotationTable tbody').empty();
            $('#quotationTable tfoot').empty();

            //Recreate the image in the right order
            qty = 0;
            total = 0;
            for (var i = 0; i < furnitureQuotation.length; i++) {
                //Add the image in the furnitureQuotation panel
                $("#furnitureQuotationBody").append("<div class='quotation-furniture'> <img id='line" + parseInt(i + 1) + "' src='" + furnitureQuotation[i].attr("src") + "' reference='" + furnitureQuotation[i].attr("reference") + "' retail='1200' title='Meuble chiens 205cm'> </div>");

                //Add line in quotation table
                qty += 1;
                total += parseInt(furnitureQuotation[i].attr("retail"));
                if (i + 1 == furnitureQuotation.length || furnitureQuotation[i].attr("reference") != furnitureQuotation[i + 1].attr("reference")) {
                    $('#quotationTable tbody').append("<tr><td>" + furnitureQuotation[i].attr("title") + "</td><td class='numeric'>" + qty + "</td> <td class='numeric'>" + formatNumber(parseInt(furnitureQuotation[i].attr("retail"))) + "</td><td class='numeric'>" + formatNumber(parseInt(qty * furnitureQuotation[i].attr("retail"))) + "</td></tr>");
                    qty = 0;
                }
                else if (i > 0) {
                }
            }

            //Add the service
            $('#quotationTable tbody').append("<tr><td>Transport et installation à proximité de " + $("#city").html() + "</td><td class='numeric'>1</td><td class='numeric'>" + formatNumber(serviceFee) + "</td><td class='numeric'>" + formatNumber(serviceFee) + "</td></tr>");
            total += serviceFee;

            //Add the total
            $('#quotationTable tfoot').append("<tr><th>Prix total</th><td></td><td></td><th class='numeric'>" + formatNumber(total) + "</th></tr>");

            //Register click event for furniture
            $(".quotation-furniture").click(function (event) {
                quotationFurnitureClick(event);
            });

            if (furnitureQuotation.length == 0) {
                $("#quotationTable").hide();
                $("#sendContact").hide();
                $("#furnitureQuotationBody").append("Aucun meuble dans votre estimation");
                $("#furnitureQuotation > .panel-footer").remove();
            }
            else {
                if ( ! $("#furnitureQuotation > .panel-footer").length )
                    $("#furnitureQuotation").append("<div class='panel-footer'>Cliquez sur les meubles pour les supprimer de votre estimation</div>");
                if (!$("#quotationTable").is(":visible")) {
                    $("#quotationTable").show("blind", 500);
                }
                $("#sendContact").show();
                setTimeout(function () { $('#quotationTable').goTo() }, 500);
            }

        } //function UpdateQuotation

        function setToolTip(element, toolTip) {
            element.qtip({ // Grab some elements to apply the tooltip to
                content: {
                    text: toolTip
                },
                position: {
                my: 'top center',  // Position my top left...
                at: 'bottom center', // at the bottom right of...
                //target: element //$('.selector') // my target
                },
                style: {
                    classes: 'qtip-rounded'
                }
            })
        }

        //Format number with space for thousand separator and comma for decimal separator
        function formatNumber(number) {
            number = number.toFixed(2) + '';
            x = number.split('.');
            x1 = x[0];
            x2 = x.length > 1 ? ',' + x[1] : '';
            var rgx = /(\d+)(\d{3})/;
            while (rgx.test(x1)) {
                x1 = x1.replace(rgx, '$1' + ' ' + '$2');
            }
            return x1 + x2;
        }

        //Scroll to the specified element
        (function ($) {
            $.fn.goTo = function () {
                $('html, body').animate({
                    scrollTop: $(this).offset().top + 'px'
                }, 'fast');
                return this; // for chaining...
            }
        })(jQuery);

        //jQuery Document ready
        var serviceFee; // = 2082.82; //3390.53    4270.85    5239.92
        var furnitureQuotation = new Array(); //Furnitures in the quotation: contains img from the catalogue
        var postedContact = "";

        $(document).ready(function () {

            //Register keypress event on name
            $("#name").keyup(function (event) {
                //keypupName(event);
                controlContactData();
            });
            //$("#name").keydown(function (event) { //backspace and delete
            //    if (event.keyCode == 8 || event.keyCode == 46) controlContactData();
//            });

            //Register keypress event on phone
            $("#phone").keyup(function (event) {
                //keyupPhone(event);
                controlContactData();
            });
            //$("#phone").keydown(function (event) {
            //    if (event.keyCode == 8 || event.keyCode == 46) controlContactData();
            //});

            //Register keypress event on mail
            $("#mail").keyup(function (event) {
                //keyupMail(event);
                controlContactData();
            });
            //$("#mail").keydown(function (event) {
            //    if (event.keyCode == 8 || event.keyCode == 46) controlContactData();
            //});

            //Register keypress event on zip code
            $("#zipCode").keyup(function (event) {
                keyupZipCode(event);
            });
            $("#zipCode").keydown(function (event) {
                if (event.keyCode == 8 || event.keyCode == 46) {
                    serviceFee = null;
                    controlContactData();
                }
            });

            //Register keypress event on zip code
            $("#zipCode").focusout(function (event) {
                controlContactData();
            });

            //Register click event for furniture
            $(".catalogue-furniture").click(function (event) {
                catalogueFurnitureClick(event);
            });

            //Inactive form button
            $("#sendContact").hide();
            $("#sendContactRow").show();

            //$("#furnitureCatalogue").show();
            //$("#furnitureQuotation").hide();
            //$("#quotationTable").hide();
            //$("#sendContact").hide();
            //$("#messagePopup").hide();
            //$("#messagePopup").show("blind", { direction: "right" }, 1000);
            //$("#furnitureCatalogue").toggle("blind", 500);
                      //{ direction: "vertical" });
            //$("#furnitureCatalogue").show("fold", 10000);

            //displayPopupMessage("Remplissez tous les champs pour accéder l'estimation en ligne", 10000, 410, $("#phone").offset().top);

            $('#furnitureCatalogueBody > div').each(function () {
                //alert($(this).find('img').attr('title'));
                setToolTip($(this), $(this).find('img').attr('title'));
            });

        });

    </script>
}